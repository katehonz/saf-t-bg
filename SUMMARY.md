# Резюме на книгата

**SAF-T в България: Счетоводен и Технически Наръчник за Практици**

---

## Манифест

SAF-T не е правен спор — той е инфраструктурен проект. Никакъв адвокат няма да ви спаси, ако базата ви данни е пълна с „свободни съчинения". XSD валидаторът на НАП не приема подкупи — той чете тагове. Тази книга е за хората, които реално ще вършат работата: счетоводителите, които трябва да станат администратори на данни, и програмистите, които трябва да разберат двустранното записване.

---

## Глава 0: Генетични дефекти на масовия БГ софтуер

Масовият български счетоводен софтуер е проектиран като плоска таблица с 20-30 свободни текстови полета („аналитичности") без релации, валидация или логика. Този архитектурен дефект, роден от манталитета на „Баба Яга" (лелката консултант, която иска безкрайна гъвкавост), прави тези системи генетично неспособни да произведат структуриран SAF-T изход. Гъвкавостта на входа е смъртната присъда на изхода.

## Глава 0А: Вторият фронт — „Дигиталните еничари“

Сблъсъкът между „старата школа“ и модерните SaaS системи, които са просто „вкарвачки на данни“ без счетоводно ядро. Защо евтиният PHP код и липсата на интеграция между склад и главна книга ще доведат до провал при генерирането на SAF-T отчети. Илюзията за модерност, която се разбива в изискванията за одитна следа и документална обоснованост.

## Глава 1: Новата реалност — Счетоводителят като Data Engineer

SAF-T премества фокуса от документа към структурата на данните. Въвежда се двойната идентификация на сметки (AccountID от НАП + TaxpayerAccountID от фирмата) — мостът, който счетоводителят трябва да построи. Мерни единици, ЕИК номера и сметкопланове трябва да бъдат изчистени (Data Cleansing) преди изобщо да се мисли за експорт.

## Глава 2: Техническият скелет — XML и Namespaces

XML е избран заради йерархичността на счетоводните данни — не са плоска таблица. Обяснени са namespace-ът `nsSAFT:`, четирите основни клона (Header, MasterFiles, GeneralLedgerEntries, SourceDocuments) и ролята на XSD като „съдия", който проверява типове, задължителност и формати. Без локална XSD валидация преди изпращане — руска рулетка.

## Глава 3: Счетоводни номенклатури и двойният сметкоплан

НАП въвежда 360 стандартни сметки. Всяка фирмена сметка трябва да бъде мапната към тях. Разгледани са XML структурата на мапването, капанът на аналитичностите (SAF-T изисква CustomerID/SupplierID в Главната книга) и данъчните кодове (TaxTable), които заменят свободните текстове като „ДДС 20%".

## Глава 4: Материални запаси — Кошмарът „При поискване"

On Demand отчетът е дигитална ревизия на склада. Описани са секциите PhysicalStock (моментна снимка с конверсии на мерни единици), MovementOfGoods (всяко складово движение свързано със счетоводна статия) и проблемът с „разнородните данни" — един продукт с три имена означава три продукта в SAF-T.

## Глава 5: Номенклатури и кореспонденции

Movement Types дефинират „защо" се случва движение (покупка, продажба, вътрешно преместване). Представен е „Мапинг двигателят" — автоматизация чрез SurrealQL Graph заявки и Rust настройки. Python скриптове за уеднаквяване на мерни единици (бр. → C62, кг → KGM) завършват картината.

## Глава 6: Техническа реализация — Rust + SurrealDB

Ядрото на системата: ~1300 реда Rust код за целия SAF-T генератор. Описани са: модел на данните (Company, Account, Counterpart), streaming XML генератор с `quick_xml`, логика за SAF-T ID префикси (10 за БГ ЕИК, 11 за ЕС ДДС, 12 за извън ЕС), три типа отчети (Monthly/OnDemand/Annual), Pre-flight валидация, SurrealDB заявки с вложени данни и Python одитни скриптове.

## Глава 7: Епилог — Краят на търговията със страх

Призив за край на кампанията по насаждане на страх от адвокатски кантори и консултанти. SAF-T е дигитална санитария, не правна революция. Счетоводителите вече са Data Engineers и трябва да изискват инструменти за мапинг, валидация и автоматизация, вместо да приемат прехвърлена отговорност. Конкретен Action Plan в 3 стъпки: какво правите веднага (тази седмица), какво в рамките на 30 дни, какво е постоянен месечен контрол. Контролен списък „Готовност за SAF-T" и минимални изисквания към софтуерния доставчик.

## Глава 8: Data Engineering — От хаоса към структурирани данни

Пълен технически фундамент: ETL pipeline архитектура (Extract → Transform → Validate → Load → Export), SurrealDB schema с SCHEMAFULL дефиниции, Rust типобезопасни модели (enums, structs, Decimal), Python Data Wrangling класове (SaftDataCleaner, CounterpartImporter, AccountMapper), PostgreSQL schema с indexes и triggers, Data Quality Framework с Rust валидатор, и async ETL pipeline с Python.

## Глава 9: SQL vs NoSQL — Избор на база данни за SAF-T

Сравнение между PostgreSQL и SurrealDB: пълен SQL schema с ENUMs, functions, triggers, materialized views; SurrealDB с Graph relations за автоматични кореспонденции; хибриден подход с Rust sync layer; performance optimization стратегии (индексиране, VACUUM ANALYZE, SurrealDB PARALLEL заявки) и benchmarking.

## Глава 10: Тестване и QA — 5 слоя валидация

Пет нива: (1) XSD Schema — XML структура, (2) Data Type — ЕИК, ДДС, мерни единици, формати, (3) Referential Integrity — външни ключове между модулите, (4) Cross-module Consistency — фактури ↔ журнални статии, ДДС рекончилиация, (5) Business Logic — двустранно записване, оборотна ведомост. Pytest framework с fixtures и GitHub Actions CI/CD интеграция.

## Глава 11: Реални казуси от практиката

Четири практически сценария (Търговец, Производител, Холдинг, ЕТ) и техните специфични предизвикателства. Данъчни рискови индикатори — какво вижда НАП, когато отвори файла: агресивни амортизации, „вечни" салда по разчетни сметки, залежали запаси и декемврийски чистки, разходи със смесено ползване без аналитичност. Python скриптове за self-assessment преди подаване. Анализ на голямата стратегическа грешка на НАП – липсата на електронно фактуриране като фундамент за SAF-T и рискът от превръщането на проекта в „дигитален боклук".

## Приложения

Справочни таблици: (А) 360 SAF-T сметки от НАП, (Б) данъчни кодове TaxTable, (В) мерни единици UOM, (Г) типове движения за склад, (Д) SAF-T ID префикси, (Е) примерен пълен XML Monthly файл, (Ж) Rust boilerplate код, (З) FAQ с най-чести въпроси и отговори.

---

*От екипа на baraba.org — 2026*
