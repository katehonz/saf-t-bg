# SAF-T в България: Счетоводен и Технически Наръчник за Практици

*Как да превърнем хаоса от данни в структуриран XML, без да се налага да ставаме юристи.*

---

## Структура на книгата

### Основни файлове
- `FULL_BOOK.md` — Пълният текст на книгата (всички глави)
- `SUMMARY.md` — Резюме на всяка глава
- `PLAN.md` — Този план и структура
- `MANIFESTO.md` — Манифест и философия

### Глави (отделни файлове)

| Глава | Файл | Заглавие |
|-------|------|----------|
| 0 | `CHAPTER_0.md` | Генетични дефекти на масовия БГ софтуер |
| 0А | `CHAPTER_0A.md` | Вторият фронт: „Дигиталните еничари“ |
| 1 | `CHAPTER_1.md` | Новата реалност: Счетоводителят като Data Engineer |
| 2 | `CHAPTER_2.md` | Техническият скелет: XML и Namespaces |
| 3 | `CHAPTER_3.md` | Счетоводни номенклатури и двойният сметкоплан |
| 4 | `CHAPTER_4.md` | Материални запаси: On-Demand отчет |
| 5 | `CHAPTER_5.md` | Номенклатури и кореспонденции |
| 6 | `CHAPTER_6.md` | Техническа реализация: Rust + SurrealDB |
| 7 | `CHAPTER_7.md` | Епилог: Краят на търговията със страх |
| 8 | `CHAPTER_8.md` | Data Engineering: ETL pipelines, типове данни |
| 9 | `CHAPTER_9.md` | SQL vs NoSQL: PostgreSQL и SurrealDB |
| 10 | `CHAPTER_10.md` | Тестване и QA: 5 слоя валидация |
| 11 | `CHAPTER_11.md` | Реални казуси от практиката |
| — | `APPENDICES.md` | Приложения: таблици, примери, FAQ |

### Ресурсни файлове (SAFT_BG/)
- `BG_SAFT_Schema_V_1.0.1.xsd` — Официална XSD схема на НАП
- `VS_SAMPLE_AuditFile_Monthly_V_1.0.1.xml` — Примерен месечен файл
- `VS_SAMPLE_AuditFile_Annual_V_1.0.xml` — Примерен годишен файл
- `VS_SAMPLE_AuditFile_OnDemand_V_1.0.xml` — Примерен On-Demand файл
- `Structure_Definition_V_1.0.1.xlsx` — Дефиниция на структурата
- `SAF-T_BG_Format_Reporting+(Приложение+3).pdf` — Официална документация

---

## Резюмета по глави

### Пролог — Глава 0: Генетични дефекти на масовия БГ софтуер
Масовият български счетоводен софтуер е проектиран като плоска таблица с 20-30 свободни текстови полета („аналитичности") без релации, валидация или логика. Този архитектурен дефект, роден от манталитета на „Баба Яга", прави тези системи генетично неспособни да произведат структуриран SAF-T изход. Гъвкавостта на входа е смъртната присъда на изхода.

### Глава 0А: Вторият фронт — „Дигиталните еничари“
Сблъсъкът между „старата школа“ и модерните SaaS системи, които са просто „вкарвачки на данни“ без счетоводно ядро. Защо евтиният PHP код и липсата на интеграция между склад и главна книга ще доведат до провал при генерирането на SAF-T отчети. Илюзията за модерност, която се разбива в изискванията за одитна следа и документална обоснованост.

- „Вкарвачи“, преоблечени като „Архитекти“
- Липсата на „Счетоводно сърце“
- Сблъсъкът със SAF-T: Крахът на интеграцията
- Генетичният дефект на евтиния PHP подход
- Между два воденични камъка

- Пророчеството на ERP архитекта
- „Баба Яга" и плоските таблици
- Гъвкавост на входа = Смърт на изхода
- Юридически хватки срещу технически изисквания
- Потьомкинското село на отсрочката
- Минимализъм като спасение

### Част I — Глава 1: Счетоводителят като Data Engineer
SAF-T премества фокуса от документа към структурата на данните. Въвежда се двойната идентификация на сметки (AccountID от НАП + TaxpayerAccountID от фирмата). Мерни единици, ЕИК номера и сметкопланове трябва да бъдат изчистени (Data Cleansing) преди изобщо да се мисли за експорт.

- История на SAF-T (OECD модел)
- Българската адаптация v1.0.1
- Двойна идентификация на сметки
- Data Cleansing процес

### Част II — Глава 2: XML и Namespaces
XML е избран заради йерархичността на счетоводните данни. Обяснени са namespace-ът nsSAFT:, четирите основни клона и ролята на XSD като „съдия". Без локална XSD валидация преди изпращане — руска рулетка.

- XML основи за счетоводители
- Namespaces (nsSAFT:)
- Структура: Header, MasterFiles, GeneralLedgerEntries, SourceDocuments
- XSD валидация

### Част III — Глава 3: Двойният сметкоплан
НАП въвежда 360 стандартни сметки. Всяка фирмена сметка трябва да бъде мапната към тях. Разгледани са капанът на аналитичностите и данъчните кодове TaxTable, които заменят свободните текстове.

- Национален сметкоплан (360 сметки)
- AccountID vs TaxpayerAccountID
- Мапване (mapping) на сметки
- TaxTable данъчни кодове

### Част IV — Глава 4: Материални запаси
On Demand отчетът е дигитална ревизия на склада. Описани са PhysicalStock, MovementOfGoods и проблемът с разнородните данни — един продукт с три имена означава три продукта в SAF-T.

- Monthly vs OnDemand vs Annual
- PhysicalStock секция
- MovementOfGoods
- UOM конверсии

### Част V — Глава 5: Номенклатури и кореспонденции
Movement Types дефинират „защо" се случва движение. Представен е „Мапинг двигателят" — автоматизация чрез SurrealQL Graph заявки и Rust настройки. Python скриптове за уеднаквяване на мерни единици завършват картината.

- Movement Types
- Автоматизация на мапинга
- SurrealQL примери
- Python data wrangling

### Част VI — Глава 6: Техническа реализация
Ядрото на системата: ~1300 реда Rust код за целия SAF-T генератор. Streaming XML с quick_xml, логика за SAF-T ID префикси, три типа отчети, Pre-flight валидация и Python одитни скриптове.

- Rust + SurrealDB архитектура
- Company, Account, JournalEntry модели
- XML streaming generator
- SAF-T ID префикси логика
- Pre-flight validation
- Python одитни скриптове

### Част VII — Глава 7: Епилог
Призив за край на кампанията по насаждане на страх. SAF-T е дигитална санитария, не правна революция. Счетоводителите вече са Data Engineers и трябва да изискват инструменти за мапинг и валидация.

- Краят на търговията със страх
- Счетоводителят на бъдещето

### Част VIII — Глава 8: Data Engineering
Пълен технически фундамент: ETL pipeline архитектура, SurrealDB schema с SCHEMAFULL, Rust типобезопасни модели, Python Data Wrangling класове, PostgreSQL schema, Data Quality Framework и async ETL pipeline.

- ETL pipeline архитектура
- SurrealDB schema (DEFINE TABLE)
- Rust типобезопасен модел
- Python data wrangling класове
- PostgreSQL schema
- Data Quality Framework
- Async ETL pipeline

### Част IX — Глава 9: SQL vs NoSQL
Сравнение между PostgreSQL и SurrealDB: пълен SQL schema с ENUMs, functions, triggers, materialized views; SurrealDB с Graph relations; хибриден подход с Rust sync layer; performance optimization и benchmarking.

- PostgreSQL vs SurrealDB сравнение
- Пълен SQL schema с triggers/views
- SurrealDB Graph relations
- Хибриден подход
- Performance optimization
- Benchmarking

### Част X — Глава 10: Тестване и QA
Пет нива валидация: XSD Schema, Data Type, Referential Integrity, Cross-module Consistency, Business Logic. Pytest framework с fixtures и GitHub Actions CI/CD интеграция.

- 5 слоя валидация
- XSD валидация (Rust/Python)
- Data Type validation
- Referential Integrity
- Cross-module Consistency
- Business Logic validation
- Pytest framework
- CI/CD integration

### Част XI — Глава 11: Реални казуси
Четири практически сценария: търговец на едро с дедупликация, производител с ВОП и VIES, холдинг с консолидация, едноличен търговец с опростен pipeline.

- Търговец на едро (дедупликация на продукти)
- Производител с ВОП (VIES, ДДС класификация)
- Холдинг (консолидация, елиминации)
- Едноличен търговец (опростен pipeline)
- Голямата стратегическа грешка (липсата на е-фактуриране)

### Приложения
Справочни таблици и код за бърза справка.

- А: Таблица на 360 SAF-T сметки
- Б: Данъчни кодове (TaxTable)
- В: Мерни единици (UOM)
- Г: Типове движения (On Demand)
- Д: Префикси за SAF-T ID
- Е: Примерен пълен XML
- Ж: Rust boilerplate код
- З: FAQ

---

## Технологичен стек

| Категория | Технологии |
|-----------|-----------|
| Backend | Rust (Dioxus 0.7, quick_xml) |
| Database | SurrealDB, PostgreSQL |
| Data Processing | Python (pandas, lxml) |
| Validation | XSD, Pytest |
| Deployment | Docker, GitHub Actions |

---

## Целева аудитория

| Аудитория | Какво ще научат |
|-----------|-----------------|
| **Счетоводители** | XML структура, мапинг, номенклатури, Data Cleansing |
| **Data Engineers** | Счетоводна логика, двойно записване, ETL pipelines |
| **Разработчици** | SAF-T имплементация, Rust/Python код, streaming XML |
| **IT Мениджъри** | Архитектура, интеграция, CI/CD, избор на база данни |

---

*От екипа на baraba.org — 2026*
