# Глава 2: Техническият скелет — Как да разбираме XML, без да сме програмисти

## 2.1. Защо XML, а не Excel?
Много счетоводители се питат: „Защо НАП не иска просто един голям Excel файл?“.
Отговорът е в йерархията. Счетоводните данни не са плоска таблица. Една транзакция има заглавна част (дата, описание) и множество редове (дебит, кредит, аналитичност, ДДС). XML (eXtensible Markup Language) позволява тази информация да бъде „увита“ логически.

## 2.2. Пространства от имена (Namespaces) — Магическото „nsSAFT:“
Ако отворите един SAF-T файл, ще видите, че всеки таг започва с `nsSAFT:`. 
Пример: `<nsSAFT:AuditFile>`

**Какво означава това на прост език?**
Това е техническият подпис на стандарта. То казва на приемащия сървър: „Внимание, всичко след мен следва стриктните правила на българската схема v1.0.1“. Ако използвате просто `<AuditFile>` без префикса, сървърът на НАП дори няма да започне да чете файла. Той ще го „изхвърли“ на входа.

## 2.3. Структурата на „Дървото“
Българският SAF-T файл е разделен на няколко основни клона. Разбирането на тези клони е разликата между успешния счетоводител и този, който ще плаща глоби.

1. **Header (Заглавие):** Тук няма счетоводство. Има метаданни. Кой е софтуерът (SoftwareID)? Коя е версията? Кой е човекът за контакт? Ако софтуерът ви е „самоделка“ без SoftwareID, файлът е невалиден.
2. **MasterFiles (Мастър данни):** Това е „речникът“. Преди да кажете, че сте продали „Домати“, трябва в MasterFiles да сте дефинирали продукта „Домати“ с неговия код и мерна единица.
3. **GeneralLedgerEntries (Главна книга):** Тук е истинското движение на пари. Всяка статия трябва да е абсолютно балансирана. Ако имате разлика от 0.01 лв. поради закръгляне в софтуера, XML-ът ще бъде отхвърлен.
4. **SourceDocuments (Първични документи):** Тук описваме фактурите (SalesInvoices / PurchaseInvoices). Връзката между `TransactionID` в Главната книга и `InvoiceNo` в Документите е това, което НАП ще използва за автоматични проверки.

## 2.4. XSD — Съдията на мача
XSD (XML Schema Definition) е файлът, който съдържа „законите“ на XML структурата. В папката `SAFT_BG` на нашия проект имаме файла `BG_SAFT_Schema_V_1.0.1.xsd`.

**Какво прави XSD?**
Той проверява:
- **Тип на данните:** Очаква ли се число или текст? (Ако в полето за сума напишете „няма“, XSD ще гръмне).
- **Задължителност:** Може ли това поле да е празно?
- **Формат:** ЕИК номерът точно 9 или 13 цифри ли е?

**Урокът:** Преди да пратите файл на НАП, вашият софтуер (като Doxius) трябва да го прекара през локален XSD валидатор. Ако софтуерът ви не поддържа локална валидация, вие играете руска рулетка.

## 2.5. Пътят на файла
Експорт от счетоводната система -> Локална XSD валидация -> Логическа проверка (баланс на сумите) -> Цифров подпис -> Изпращане към НАП.

Всеки „експерт“, който ви говори за SAF-T, но не споменава XSD валидация, просто не знае за какво говори.
